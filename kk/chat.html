<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
    <link rel="stylesheet" href="chatStyle.css">
    <script src="reconnecting-websocket.min.js"></script>
    <script src="moment.js"></script>
    <link rel="shortcut icon" href="faviocn.png" type="image/png">
    <title>knock-knock</title>
</head>
<body>
<div style="position: fixed; width: 100%">
    <input class=" w3-margin w3-input w3-xxxlarge w3-left" placeholder="введите сообщение" style="width: 80%"
           onkeydown="KeyDown1(event)" id="InputMSG"/>
    <button onclick="send2('text')" class="w3-button w3-round-large w3-hover-opacity w3-margin w3-xlarge"
            style="width: 10%; background-color:#91c5d5;"><img src="send-button.png"></button>
    <br>
    <br>
    <div class="w3-display-container">
        <button onclick='address_change()' id="address_st"
                class="w3-button w3-round-large w3-hover-opacity w3-margin w3-xlarge w3-black w3-left"
                style="width: 30%; float: left">Кому: всем
        </button>
        <div class="w3-dropdown-hover w3-xlarge" style="width: 50%">
            <button class="w3-button w3-black w3-button w3-round-large w3-hover-opacity w3-margin w3-xlarge w3-black"
                    style="width: 100%">Стикеры
            </button>
            <div class="w3-dropdown-content w3-bar-block w3-border w3-right" id="textView"
                 style="width: 100%; overflow: auto; max-height: 500px">

            </div>
        </div>
        <button class="w3-button w3-black w3-round-large w3-hover-opacity w3-margin w3-xlarge w3-display-topright"
                style="height: 70%" onclick="return location.href = 'index.html'"><img src="home.png">
        </button>
    </div>
    <button class="w3-btn w3-hover-opacity w3-black w3-margin w3-padding w3-left w3-xxxlarge" id="arrow"  style="opacity: 1" onclick="f1()">⟱</button>
</div>


<div id="id01" class="w3-panel w3-red" style="display: none; width: 15%;position: fixed">
    <h2 style="font-size: 50px">Вы не ввели имя!</h2>
    <br>
    <span onclick="document.getElementById('id01').style.display='none'"
          class="w3-button w3-left w3-margin w3-xlarge w3-black">Хорошо</span>
</div>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<script>
    var users_map = {};
    function f1() {
        document.documentElement.scrollTop = document.body.scrollHeight
    }
    function ping() {
        // inbox.send('{"system": "true", "name": "ping", "key": "key", "event": "ping"}');
        outbox.send('{"system": "true", "name": "ping", "key": "key", "event": "ping"}');
    }
    setInterval(ping, 10000);

    function sticker(src_var) {
        if (typeof localStorage.getItem("uuid") == "object") {
            localStorage.setItem("uuid", uuid())
        }
        var uuidNow = localStorage.getItem("uuid");
        var icon = localStorage.getItem("icon");
        var time = moment().format('MMMM Do YYYY, h:mm:ss a');
        if (addressGlobal != "") {
            var msg = {
                system: "false",
                uuid: uuidNow,
                text: src_var,
                name: localStorage.getItem("name"),
                icon: icon,
                time: time,
                address: addressGlobal,
                nameAddress: addressGlobalName,
                type: "img"
            };
            NewMsg(msg.text, "для " + msg.nameAddress, true, msg.icon, msg.time, true, msg.uuid, msg.name, "img");

        }
        else {
            var msg = {
                system: "false",
                uuid: uuidNow,
                text: src_var,
                name: localStorage.getItem("name"),
                icon: icon,
                time: time,
                type: "img"
            };
        }
        outbox.send(JSON.stringify(msg));
        document.getElementById("InputMSG").value = ""
    }

    function address_change() {
        addressGlobal = "";
        document.getElementById("address_st").innerHTML = "Кому: всем"

    }

    var startMsgs = 0;
    var addressGlobal = "";
    var addressGlobalName;

    var users = {};
    var inbox = new ReconnectingWebSocket("wss://" + "warm-bayou-37022.herokuapp.com" + "/receive");
    inbox.onopen = function () {
        var id = localStorage.getItem("uuid");
        var msg = {key: id, msg: "true", name: localStorage.getItem("name"), token: localStorage.getItem("token")[0]};
        inbox.send(JSON.stringify(msg));


    };
    inbox.onclose = function () {

    };

    var outbox = new ReconnectingWebSocket("wss://" + "warm-bayou-37022.herokuapp.com" + "/submit");
    // outbox.onopen = function(){
    //     var id = localStorage.getItem("uuid");
    //     var msg = {key: id, msg: "true", name: localStorage.getItem("name"), token: localStorage.getItem("token")[0]};
    //     outbox.send(JSON.stringify(msg))
    // };
    inbox.onclose = function () {
        location.reload()
    };


    function KeyDown1(event) {
        if (event.keyCode == 13 && document.getElementById("InputMSG").value != "") {
            send2()
        }
    }

    function send2() {
        if (document.getElementById("InputMSG").value != "") {
            document.getElementsByClassName("msg")[document.getElementsByClassName("msg").length - 1].scrollIntoView(true);
            var MsgText = document.getElementById("InputMSG").value;
            if (typeof localStorage.getItem("uuid") == "object") {
                localStorage.setItem("uuid", uuid())
            }
            var uuidNow = localStorage.getItem("uuid");
            var icon = localStorage.getItem("icon");
            var time = moment().format('MMMM Do YYYY, h:mm:ss a');
            if (addressGlobal != "") {
                var msg = {
                    system: "false",
                    uuid: uuidNow,
                    text: MsgText,
                    name: localStorage.getItem("name"),
                    icon: icon,
                    time: time,
                    address: addressGlobal,
                    nameAddress: addressGlobalName,
                    type: "text"
                };
                NewMsg(msg.text, "для " + msg.nameAddress, true, msg.icon, msg.time, true, msg.uuid, msg.name, "text");

            }
            else {
                var msg = {
                    system: "false",
                    uuid: uuidNow,
                    text: MsgText,
                    name: localStorage.getItem("name"),
                    icon: icon,
                    time: time,
                    type: "text"
                };
            }
            outbox.send(JSON.stringify(msg));
            document.getElementById("InputMSG").value = ""
        }
    }

    function check(uuid) {
        return uuid == localStorage.getItem("uuid");
    }

    inbox.onmessage = function (data) {
        var time = moment().format('MMMM Do YYYY, h:mm:ss a');
        var msg = JSON.parse(data.data);
        if (msg.system == "true") {
            if (msg.event == "reg") {
                if (msg.key != localStorage.getItem("uuid")) {
                    users[msg.key] = msg.name;
                    systemMsg("Пользователь " + msg.name, time, "подключился")

                }
            }
            if (msg.event == "close") {
                if (msg.key != localStorage.getItem("uuid")) {
                    delete (users[msg.key]);
                    systemMsg("Пользователь " + msg.name, time, "отключился")
                }

            }
            if(msg.end === "true"){
                all = true;
            }
            if(msg.event === "map"){
                users_map[msg.id] = msg.name
            }
        }
        else {
            Msg(msg)
        }

        startMsgs++;
    };

    function Msg(msg) {


        if (typeof msg.address == "undefined") {
            if (check(msg.uuid)) {
                NewMsg(msg.text, "вы", true, msg.icon, msg.time, false, msg.uuid, msg.name, msg.type);

            }
            else {
                NewMsg(msg.text, msg.name, false, msg.icon, msg.time, false, msg.uuid, msg.name, msg.type);

                soundClick();


            }
        }
        else {
            if (check(msg.uuid)) {
                NewMsg(msg.text, "для " + msg.nameAddress, true, msg.icon, msg.time, true, msg.uuid, msg.name, msg.type);


            }
            else {
                NewMsg(msg.text, "для вас от " + msg.name, false, msg.icon, msg.time, true, msg.uuid, msg.name, msg.type);

                soundClick();


            }
        }

    }

    function uuid() {
        var now = new Date();
        return (now.getMilliseconds() + now.getHours() + now.getMinutes()) * Math.random(-1, 100);
    }
    var f;
    window.onfocus = function() {
        f = false;
    };
    window.onblur = function() {
        f = true;
    };

    function soundClick() {
        if (f === true) {
            var audio = new Audio(); // Создаём новый элемент Audio
            audio.src = 'click.mp3'; // Указываем путь к звуку "клика"
            audio.autoplay = true; // Автоматически запускаем
        }
    }


    function systemMsg(name, time_obj, msg) {

        var newDiv = document.createElement("h3");
        newDiv.className = "system w3-blue";
        var newContent = document.createTextNode(name + " " + msg);
        var time = document.createElement("SPAN");
        time.innerHTML = time_obj;
        time.className = "time";
        var br = document.createElement("br");
        var br2 = document.createElement("br");
        var br3 = document.createElement("br");
        var br4 = document.createElement("br");
        var br5 = document.createElement("br");
        var br6 = document.createElement("br");
        var br7 = document.createElement("br");
        var br8 = document.createElement("br");
        var br9 = document.createElement("br");
        br.className = "del";
        br2.className = "del";
        br3.className = "del";
        br4.className = "del";
        br5.className = "del";
        br6.className = "del";
        br7.className = "del";
        br8.className = "del";
        br9.className = "del";
        newDiv.appendChild(time);
        newDiv.appendChild(br6);
        newDiv.appendChild(newContent);
        var currentDiv = document.getElementById("InputMsg");
        document.body.insertBefore(newDiv, currentDiv);
        document.body.insertBefore(br, newDiv);
        document.body.insertBefore(br2, newDiv);
        document.body.insertBefore(br3, newDiv);
        document.body.insertBefore(br4, newDiv);
        document.body.insertBefore(br5, newDiv);
        document.body.insertBefore(br7, newDiv);
        document.body.insertBefore(br8, newDiv);
        document.body.insertBefore(br9, newDiv);
        newDiv.scrollIntoView(true);
        del(newDiv, br, br2, br3, br4, br5, br6, br7, br8, br9)

    }
    var cur_count_msg = 30;
    var all = true;

     window.onscroll = function() {
         var scrolled = document.documentElement.scrollTop;

         if (document.documentElement.scrollTop===document.documentElement.scrollHeight-document.documentElement.clientHeight){
             document.getElementById("arrow").style.opacity = '0'
         }

         if (document.documentElement.scrollTop!==document.documentElement.scrollHeight-document.documentElement.clientHeight) {

             document.getElementById("arrow").style.opacity = '1'
         }
         if (scrolled === 0){

             while (document.getElementsByClassName('msg').length > 0){
                 document.getElementsByClassName('msg')[0].parentNode.removeChild(document.getElementsByClassName('msg')[0])
             }


             setTimeout(
                 function () {
                    all = false;
                     inbox.send(JSON.stringify({
                         "lim": cur_count_msg + 30,
                         "msg": "false",
                         "key": localStorage.getItem('uuid'),
                         "start": 0
                     }));
                     cur_count_msg += 30;
                 }, 5
             );


        }
    };

    function del(obj, br, br2, br3, br4, br5, br6, br7, br8, br9) {
        var opacity = 1;
        for (var i = 5000; i < 7000; i += 10) {
            setTimeout(function () {
                obj.style = 'opacity: ' + opacity.toString();
                opacity -= 0.005
            }, i)
        }
        setTimeout(function () {
            var parent = obj.parentElement;
            parent.removeChild(obj);
            parent.removeChild(br);
            parent.removeChild(br2);
            parent.removeChild(br3);
            parent.removeChild(br4);
            parent.removeChild(br5);
            parent.removeChild(br7);
            parent.removeChild(br8);
            parent.removeChild(br9);

        }, 7000)
    }


    function NewMsg(msg, name, mine, icon, time_obj, address2, uuid, nameAddress, type) {


        var parentDiv = document.createElement("DIV");
        var newDiv = document.createElement("DIV");
        parentDiv.className = "msg w3-container";
        var newContent;
        if (type == "img") {
            newContent = document.createElement("IMG");
            newContent.src = msg;
            newContent.style.maxWdth = "300px";
            newContent.style.maxHeight = "300px"
        }
        else {
            newContent = document.createTextNode(name + ": " + msg);
        }

        var time = document.createElement("DIV");
        time.innerHTML = time_obj;
        time.className = "time";

        newDiv.onclick = function () {
            addressGlobal = uuid;
            addressGlobalName = nameAddress;
            document.getElementById("address_st").innerHTML = "Кому: " + nameAddress
        };
        if (!mine) {
            newDiv.className = "messageLeft w3-hover-opacity w3-left";

        }
        if (mine) {
            newDiv.className = "messageRight w3-hover-opacity w3-right";
        }

        if (!mine && address2) {
            newDiv.className = "messageLeft_red w3-hover-opacity w3-left";

        }
        if (mine && address2) {
            newDiv.className = "messageRight_red w3-hover-opacity w3-right";
        }


        if (icon == 1) {
            var img = document.createElement("IMG");
            img.src = "anonymous1.png";

        }
        else if (icon == 2) {
            var img = document.createElement("IMG");
            img.src = "anonymous2.png";

        }
        else if (icon == 3) {
            var img = document.createElement("IMG");
            img.src = "anonimus3.png";


        }
        newDiv.appendChild(time);
        newDiv.appendChild(img);
        if (type == "img") {
            newDiv.appendChild(document.createTextNode(name + ":"));
        }
        newDiv.appendChild(newContent);
        var currentDiv = document.getElementById("InputMsg");
        parentDiv.appendChild(newDiv);

        document.body.appendChild(parentDiv);
//
        if (all === true) {
            newDiv.scrollIntoView(true);
        }
        else {
            document.getElementsByClassName("msg")[30].scrollIntoView(true)
        }

    }

    window.onload = function () {
        var stickers = JSON.parse(localStorage.getItem("stickers"));

        for (var i = 0; i < stickers.length; i++) {
            var parent = document.getElementById("textView");
            var child = document.createElement("div");
            child.className = "w3-bar-item w3-button";
            child.onclick = function (_i) {
                return function () {
                    sticker(stickers[_i])
                }
            }(i);
            var img = document.createElement("img");
            img.src = stickers[i];
            img.style.width = "10%";
            child.appendChild(img);

            parent.appendChild(child);
        }
        if (localStorage.getItem("name") == "" || typeof localStorage.getItem("icon") == "object" || typeof localStorage.getItem("name") == "object") {
            alert("введите имя!");
            location.href = "index.html";

        }

    }
</script>
</body>
</html>